<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <title>Priorities</title>
    <script type="text/javascript" src="js/vue.global.prod.js"></script>
    <link rel="stylesheet" href="css/pico.min.css">
  </head>
  <body>
    <main class="container">
      <div id="app">
        <h1>Priorities</h1>
	<div class="grid">
	  <div id="docs">
	    <details>
	      <summary>This is a tool for prioritizing a list of items.</summary>
	      <p>Sorting a list of three options is easy to do off the top of your head, but it's less obvious how to order ten options. This tool orders them by counting the number of times each option was chosen in all of the pairwise comparisons; for <math>n</math> options, the number of pairs is the sum of the integers from <math>n - 1</math> down to <math>1</math>. In the case of ten options, you'd make 45 comparisons.</p>
	      <details><summary>Settings</summary><p><button class="outline" :class="{ secondary: !bubble }" @click="bubble = !bubble">bubble</button> <i>Unmade choices float to the top</i></p></details>
	    </details>
	  </div>
	</div>
	<div class="grid">
          <div id="options">
            <p>
              <i>Type or paste options here, one to a line</i>
            </p>
            <textarea cols="30" id="" name="" rows="10" v-model="options">
            </textarea>
          </div>
          <div id="selections">
            <p v-if="selectionsLength"><i>Choose preferences ({{ numberRemaining }} of {{ selectionsLength }} remaining)</i></p>
            <article v-for="pair of buttons">
              <button :class="{ secondary: pair.button0 !== pair.choice }" @click="choose(pair.selection, 0)">{{ pair.button0 }}</button> or <button :class="{ secondary: pair.button1 !== pair.choice }" @click="choose(pair.selection, 1)">{{ pair.button1 }}</button>
            </article>
          </div>
          <div id="sortedoptions">
            <p v-if="allChosen"><i>Scored options</i></p>
            <template v-if="allChosen" v-for="score of sortedOptions" :key="score">
              <p v-if="allChosen"><i>{{ score[0] }}</i>: <span v-if="allChosen" v-for="(option, idx) in score[1]"><span v-if="idx != 0">&nbsp;</span><mark>{{ option }}</mark></span></p>
            </template>
          </div>
	</div>
      </div>
    </main>
  </body>
  <script>
    var app = Vue.createApp({
      data() {
        return {
          options: "",
          selections: {},
	  bubble: false
        }
      },
      methods: {
        arrayToPairStrings(ary) {
          let pairs = [];
          for (let i = 0 ; i < ary.length - 1 ; i++) {
            for (let j = i + 1 ; j < ary.length ; j++) {
              pairs.push(JSON.stringify([ary[i], ary[j]]));
            }
          }
          return pairs;
        },
        choose(selection, idx) {
          let pair = JSON.parse(selection);
          this.selections[selection] = pair[idx];
        },
        optionsToList(o) {
          return [...new Set(o.split("\n").filter(item => item !== ""))]
        },
	buttonSort(a, b) {
	  if (a.choice === "" && b.choice !== "") {
	    return -1
	  } else if (a.choice !== "" && b.choice === "") {
	    return 1
	  } else {
	    return this.defaultSort(a, b);
	  }
	},
	defaultSort(a, b) {
	  let optionsList = this.optionsToList(this.options);
	  let firstOptionComparison = optionsList.indexOf(a.button0) - optionsList.indexOf(b.button0);
	  if (firstOptionComparison !== 0) {
	    return firstOptionComparison;
	  } else {
	    return optionsList.indexOf(a.button1) - optionsList.indexOf(b.button1);
	  }
	},
      },
      watch: {
        options(newOptions, oldOptions) {
          if (!newOptions) {
            this.selections = {};
          } else {
            let newPairStrings = this.arrayToPairStrings(this.optionsToList(newOptions));
            let oldPairStrings = this.arrayToPairStrings(this.optionsToList(oldOptions));
            let newSelections = {};
            for (let pairString of oldPairStrings) {
              if (newPairStrings.indexOf(pairString) > -1) {
                newSelections[pairString] = this.selections[pairString];
              }
            }
            for (let pairString of newPairStrings) {
              if (oldPairStrings.indexOf(pairString) === -1) {
                newSelections[pairString] = "";
              }
            }
            this.selections = newSelections;
          }
        }
      },
      computed: {
        sortedOptions() {
          let options = {};
          for (let option of this.optionsToList(this.options)) {
            let score = Object.values(this.selections).filter(s => s === option).length.toString();
            if (score in options) {
              options[score].push(option);
            } else {
              options[score] = [option];
            }
          }
          return Object.entries(options).toSorted().toReversed();
        },
        allChosen() {
          return Object.keys(this.selections).length && Object.values(this.selections).every(s => s !== "");
        },
        selectionsLength() {
          return Object.keys(this.selections).length;
        },
        numberRemaining() {
          return Object.values(this.selections).filter(s => s === "").length;
        },
        buttons() {
          let buttons = [];
          for (let selection of Object.entries(this.selections)) {
            let choices = JSON.parse(selection[0]);
            buttons.push({
              "selection": selection[0],
              "button0": choices[0],
              "button1": choices[1],
              "choice": selection[1]
            });
          }
	  if (this.bubble) {
            return buttons.toSorted(this.buttonSort);
	  } else {
	    return buttons.toSorted(this.defaultSort);
	  }
        },
      }
    })
    app.mount("#app")
  </script>
</html>
